<!DOCTYPE HTML>
<html>
  <head> <meta charset="utf-8"/>
<meta name="generator" content="Docutils 0.16: http://docutils.sourceforge.net/" />
<title>Breakpoint: Exploiting Gource</title>
    <link rel="stylesheet" type="text/css" href="../style/base.css"/>
    <link rel="stylesheet" type="text/css" href="../style/pygments.css"/>

    <link rel="alternate" type="application/rss+xml" title="Breakpoint RSS" href="../rss.xml"/>
    <link rel="alternate" type="application/rss+xml" title="Stream of Consciousness RSS" href="../soc_rss.xml"/>
  </head>
  <body>
    <header class="site-header">
      <div class="site-title">
        <div class="title-text">
          <h1>Breakpoint</h1>
          <h2>Stepping through security</h2>
        </div>
        <img src="../image/tomoko1.png"/>
      </div>
      <div class="wrap">
        <ul>
          <li><a href="../index.html">Index</a></li>
          <li><a href="https://github.com/cym13">Github</a></li>
          <li><a href="../soc.html">SoC</a></li>
          <li><a href="../about.html">About</a></li>
        </ul>
      </div>
    </header>

    <div class="content">
      <div class="section" id="exploiting-gource">
<h1>Exploiting Gource</h1>
<div class="section" id="the-code">
<h2>The code</h2>
<p>The code analyzed is taken from the HEAD commit on master on
<a class="reference external" href="https://github.com/acaudwell/Gource">https://github.com/acaudwell/Gource</a> (474870a3d7af80e109e3fd5ab328039c259e6821).</p>
<p>This was written while performing the review so don't expect everything to
work flawlessly ;)</p>
<p>I start by looking for <em>system()</em> as it's often a reliable way to produce
bugs. It turns out to be present under the wrapper <em>systemCommand()</em>. This
wrapper is there to ensure compatibility with C++ strings. Where is this
wrapper used?</p>
<pre class="code bash literal-block"><code><span class="c1"># avoid the definition place
</span>
$ grep -r <span class="s2">&quot;systemCommand[^{]\+&quot;</span>
formats/bzr.cpp:    int <span class="nv">command_rc</span> <span class="o">=</span> systemCommand<span class="o">(</span>cmd_buff<span class="o">)</span><span class="p">;</span>
formats/svn.cpp:    int <span class="nv">command_rc</span> <span class="o">=</span> systemCommand<span class="o">(</span>cmd_buff<span class="o">)</span><span class="p">;</span>
formats/hg.cpp:    int <span class="nv">command_rc</span> <span class="o">=</span> systemCommand<span class="o">(</span>cmd_buff<span class="o">)</span><span class="p">;</span>
formats/git.cpp:    int <span class="nv">command_rc</span> <span class="o">=</span> systemCommand<span class="o">(</span>cmd_buff<span class="o">)</span><span class="p">;</span>
formats/git.cpp:        <span class="nv">command_rc</span> <span class="o">=</span> systemCommand<span class="o">(</span>cmd_buff<span class="o">)</span><span class="p">;</span></code></pre>
<p>Ok, so pretty much for every format. We'll start with git.</p>
<p>The function that uses this function is <em>GitCommitLog::generatelog</em>. Here is
the relevant part (starting line 98):</p>
<pre class="code cpp literal-block"><code><span class="kt">char</span> <span class="n">cmd_buff</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd_buff</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="s">&quot;%s &gt; %s&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">temp_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

<span class="kt">int</span> <span class="n">command_rc</span> <span class="o">=</span> <span class="n">systemCommand</span><span class="p">(</span><span class="n">cmd_buff</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="n">command_rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">chdir</span><span class="p">(</span><span class="n">cwd_buff</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// check for new-enough Git version
// if %aN does not appear to be supported try %an
</span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">in</span><span class="p">(</span><span class="n">temp_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="kt">char</span> <span class="n">firstBytes</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
<span class="n">in</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">firstBytes</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="n">in</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="n">firstBytes</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">firstBytes</span><span class="p">,</span> <span class="s">&quot;user:%aN&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd_buff</span><span class="p">,</span> <span class="s">&quot;%aN&quot;</span><span class="p">);</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'n'</span><span class="p">;</span>
    <span class="n">command_rc</span> <span class="o">=</span> <span class="n">systemCommand</span><span class="p">(</span><span class="n">cmd_buff</span><span class="p">);</span>
<span class="p">}</span></code></pre>
<p>Ok, so we build a buffer with a command and a temporary file path. Then we
execute it. If the temporary file does not begin by &quot;user:%aN&quot; we also get
the benefit of a second execution of the same payload (with one byte changed
if we have &quot;%aN&quot; in our command).</p>
<p>There are two problems that we will see in order here: arbitrary command
execution through parameter injection and possible file overwrite.</p>
<p>Actually there is a third potential problem: a possible null pointer
dereference if &quot;%aN&quot; isn't found in the command, but it turns out to be
impossible.</p>
</div>
<div class="section" id="arbitrary-code-execution">
<h2>Arbitrary code execution?</h2>
<p>The most common vulnerability associated with the use of <em>system()</em> is the
lack of proper escaping when building the command string.</p>
<p>Here the command is build in the function <em>GitCommitLog::logCommand</em>:</p>
<pre class="code cpp literal-block"><code><span class="c1">//git-log command notes:
// - no single quotes on WIN32 as system call treats them differently
// - 'user:' prefix allows us to quickly tell if the log is the wrong format
//   and try a different format (eg cvs-exp)
</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">GitCommitLog</span><span class="o">::</span><span class="n">logCommand</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">log_command</span> <span class="o">=</span> <span class="s">&quot;git log &quot;</span>
    <span class="s">&quot;--pretty=format:user:%aN%n%ct &quot;</span>
    <span class="s">&quot;--reverse --raw --encoding=UTF-8 &quot;</span>
    <span class="s">&quot;--no-renames&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">gGourceSettings</span><span class="p">.</span><span class="n">start_date</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">log_command</span> <span class="o">+=</span> <span class="s">&quot; --since &quot;</span><span class="p">;</span>
        <span class="n">log_command</span> <span class="o">+=</span> <span class="n">gGourceSettings</span><span class="p">.</span><span class="n">start_date</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">gGourceSettings</span><span class="p">.</span><span class="n">stop_date</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">log_command</span> <span class="o">+=</span> <span class="s">&quot; --until &quot;</span><span class="p">;</span>
        <span class="n">log_command</span> <span class="o">+=</span> <span class="n">gGourceSettings</span><span class="p">.</span><span class="n">stop_date</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">gGourceSettings</span><span class="p">.</span><span class="n">git_branch</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">log_command</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
        <span class="n">log_command</span> <span class="o">+=</span> <span class="n">gGourceSettings</span><span class="p">.</span><span class="n">git_branch</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">log_command</span><span class="p">;</span>
<span class="p">}</span></code></pre>
<p>Dates are generally highly structured values, we won't lose time on them. The
branch name is more interesting. Where does it come from? It turns out it can
be provided with a command line flag. Here is the relevant code in
<em>gource_settings.cpp</em>:</p>
<pre class="code cpp literal-block"><code><span class="k">if</span><span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">gource_settings</span><span class="o">-&gt;</span><span class="n">getEntry</span><span class="p">(</span><span class="s">&quot;git-branch&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">hasValue</span><span class="p">())</span> <span class="n">conffile</span><span class="p">.</span><span class="n">missingValueException</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

    <span class="n">Regex</span> <span class="nf">branch_regex</span><span class="p">(</span><span class="s">&quot;^(?!-)</span><span class="p">[</span><span class="o">/</span><span class="err">\\</span><span class="n">w</span><span class="p">.,;</span><span class="n">_</span><span class="o">=+</span><span class="p">{}</span><span class="err">\\</span><span class="p">[</span><span class="err">\\</span><span class="p">]</span><span class="o">-</span><span class="p">]</span><span class="o">+</span><span class="err">$</span><span class="s">&quot;);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">branch</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">getString</span><span class="p">();</span>

    <span class="k">if</span><span class="p">(</span><span class="n">branch_regex</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">branch</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="n">branch</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">conffile</span><span class="p">.</span><span class="n">invalidValueException</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
<p>So we check the branch name with a regex. We cannot use space, quotes, a
dollar sign, parentheses an exclamation mark or a backslash. This makes any
shell injection very, very hard. So let's skip this one, we won't make it.</p>
</div>
<div class="section" id="file-overwrite">
<h2>File overwrite</h2>
<p>The other vulnerability is a file overwrite. Where? In the first snippet we
saw.</p>
<pre class="code cpp literal-block"><code><span class="kt">char</span> <span class="n">cmd_buff</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd_buff</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="s">&quot;%s &gt; %s&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">temp_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span></code></pre>
<p>Why is it problematic? Well, snprintf will write a maximum of 2048 bytes into
the cmd_buff, but remember that we can control the branch name which will
impact the length of the command. What if <em>command</em> takes 2036 bytes? With
the redirection and the terminating null byte it will leave only 8 byte for
the destination path no matter what its complete name is. So if the file path
is <em>/tmp/tmp.XXXXXX</em> the command will in fact be truncated just before the
dot so that the output file is <em>/tmp/tmp</em>.</p>
<p>This means that if the temporary file name has a deterministic beginning we
can write the output of the command to a deterministic path.</p>
<p>So the question is: how are those temporary paths determined? This is done by
the <em>RCommitLog::createTempLog</em> function (ignoring everything WIN32 related):</p>
<pre class="code cpp literal-block"><code><span class="kt">void</span> <span class="n">RCommitLog</span><span class="o">::</span><span class="n">createTempLog</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tempdir</span><span class="p">;</span>

    <span class="n">tempdir</span> <span class="o">=</span> <span class="s">&quot;/tmp/&quot;</span><span class="p">;</span>

    <span class="kt">char</span> <span class="n">tmplate</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">tmplate</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">&quot;%sgource-XXXXXX&quot;</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

    <span class="k">if</span><span class="p">(</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">tmplate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">temp_file</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">tmplate</span><span class="p">);</span>
<span class="p">}</span></code></pre>
<p>So do we have a deterministic beginning? We sure do! All paths will begin by
<em>/tmp/gource-</em>. And note that <em>/tmp</em> is a directory that is notoriously open
to all users in read and write access.</p>
<p>This can be used in many attacks although the most common is some form of
privilege escalation.</p>
</div>
<div class="section" id="privilege-escalation">
<h2>Privilege escalation</h2>
<p>Privilege escalations are an interesting topic because contrary to a
situation in which you are a remote attacker you already have some leverage
on the system.</p>
<p>Here we will consider an hypothetical case where a service allows the user to
run gource on a project provided by the user through a dedicated interface
that allows him to specify the branch of the project. The user is
unprivileged but has access to the machine. The service is more privileged
than the user.</p>
<p>As we saw, having leverage over the branch name means the user can force the
output to a specific file. The user has access to the <em>/tmp</em> directory. He
will specify a branch long enough to force the output to <em>/tmp/go</em>. It could
be any name really, all we need is for it not to exist (or under our
control).</p>
<p>Before launching Gource the user will create a symbolic link from <em>/tmp/go</em>
to another file. For example <em>~/.ssh/authorized_keys</em>. This file lists public
keys that can access one's account through ssh. The link needs to be adapted
to the home of the home of the user running the service but it is not a
problem as /etc/passwd is publicly available.</p>
<p>If we run Gource at this point we will effectively write into the service's
<em>.ssh/authorized_keys</em>. This will destroy all its keys (the principle can be
used for DoS by overwritting important files) but we want more. We want our
own key in that file.</p>
<p>What are we writting exactly? Due to the format imposed to git log (the
command we're executing) it looks like this:</p>
<pre class="literal-block">user:Andrew Caudwell
1469667059
user:Andrew Caudwell
1469664776
user:Andrew Caudwell
1469262949
user:Andrew Caudwell
1454470834
user:Andrew Caudwell
1454470085
user:Andrew Caudwell
1454467571
user:Andrew Caudwell
1439176020
user:Andrew Caudwell
1427667398</pre>
<p>A bunch of user names and timestamps. How can we get our key in there? By
commiting to a project with our key as username! That's why we need to have
some leverage on the project being Gourced.</p>
<p>The <em>authorized_keys</em> file has a nice property: it ignores any line that
doesn't begin by a key. So all we need to do is make sure the key is alone on
its line. We do that by prepending and appending a carriage return to our
key. This makes it a very long and weird line but who cares.</p>
<p>By launching the service with this project, our symbolic link in place and
the proper branch name we will insert our public key into the service's
<em>authorized_keys</em>. All we need to do next is using ssh to log in with its
account and benefit of all its privileges.</p>
<p>Of course this can be adapted: we could have overwritten the bashrc, or the
crontab to insert a shell command for example.</p>
<p>This is hard to pull off remotely because it requires some leverage but it is
by no mean impossible to do.</p>
</div>
<div class="section" id="the-fix">
<h2>The fix</h2>
<p>The best way to fix is to check that you aren't writting more than you
should. <em>snprintf</em> returns the number of bytes it would have written if it
had not been stopped. A correct code could be:</p>
<pre class="code cpp literal-block"><code><span class="kt">char</span> <span class="n">cmd_buff</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">written</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cmd_buff</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span>
                       <span class="s">&quot;%s &gt; %s&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">temp_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">written</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span></code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This was fixed on Gource master a few hours after disclosure by commit
eab1bbeab18cd59e263d823167e7b7947a8f5c16.</p>
</div>
</div>
</div>
    </div>
    <footer "class"="site-footer">
      <div "class"="publication_date">
        First published: Sat, 25 Feb 2017 01:37:33 +0100
      </div>
    </footer>
  </body>
</html>
